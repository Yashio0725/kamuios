{{/* Dynamic SaaS Dashboard Generator */}}
{{/* このパーシャルはdata/saas/ディレクトリの全YAMLファイルを読み込んで、カテゴリ別にダッシュボードを生成します */}}

{{/* CSSスタイルの定義 */}}
<style>
  .dashboard-sections {
    margin-bottom: 40px;
  }
  .dashboard-section-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
  }
  .dashboard-links {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .saas-app-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
    color: var(--text);
    display: block;
  }
  
  /* ライトモードで白背景 */
  [data-theme="light"] .saas-app-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
  }
  
  .saas-app-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    border-color: #4a9eff;
  }
  
  .saas-app-title {
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 12px;
    color: #4a9eff;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .saas-app-description {
    font-size: 0.95rem;
    color: var(--text-weak);
    line-height: 1.6;
    margin-bottom: 12px;
  }
  
  .saas-app-features {
    font-size: 0.85rem;
    color: var(--text-weak);
    line-height: 1.8;
  }
  
  .saas-app-arrow {
    color: #4a9eff;
    font-size: 1.2rem;
    display: inline-block;
    margin-left: 8px;
    transition: transform 0.3s ease;
  }
  
  .saas-app-card:hover .saas-app-arrow {
    transform: translateX(4px);
  }
  
  .private-badge {
    background: #ff6b6b;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 8px;
  }
</style>

<!-- ダッシュボードセクション -->
<div class="dashboard-sections">
  <div class="dashboard-links">
    {{/* メインダッシュボードカード - 常に表示 */}}
    <a href="#" class="saas-app-card" onclick="window.location.hash=''; location.reload(); return false;">
      <video src="/videos/dashboard_card.mp4" alt="メインダッシュボード" style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;" autoplay loop muted playsinline></video>
      <div class="saas-app-title">
        メインダッシュボード
        <span class="saas-app-arrow">→</span>
      </div>
      <div class="saas-app-description">
        全体のダッシュボード - 各セクションへのエントリーポイント
      </div>
      <div class="saas-app-features">
        • 要件定義・開発<br>
        • メディアエディタ<br>
        • 事業構築・ビジネスツール
      </div>
    </a>
    
    {{/* Dynamic Media Galleryカード - 特別扱い */}}
    <a href="#dynamic-media-gallery" class="saas-app-card" onclick="showSectionById('dynamic-media-gallery'); return false;">
      <video src="/videos/media_gallery_card.mp4" alt="Dynamic Media Gallery" style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;" autoplay loop muted playsinline></video>
      <div class="saas-app-title">
        Dynamic Media Gallery
        <span class="saas-app-arrow">→</span>
      </div>
      <div class="saas-app-description">
        メディアファイルを動的にスキャンして表示するギャラリー
      </div>
      <div class="saas-app-features">
        • ファイル自動スキャン<br>
        • グリッド/リスト表示<br>
        • ライトボックス対応
      </div>
    </a>
  </div>
</div>

{{/* data/saas/ディレクトリから動的にセクションを生成 */}}
{{/* 全YAMLファイルを取得してカテゴリ別にグループ化 */}}
{{ $categories := dict }}
{{ range $filename, $content := .Site.Data.saas }}
  {{ range $item := $content }}
    {{ if $item.category }}
      {{ $categoryName := $item.category_name | default "その他" }}
      {{ $categoryItems := index $categories $categoryName | default (slice) }}
      {{ $categoryItems = $categoryItems | append $item }}
      {{ $categories = merge $categories (dict $categoryName $categoryItems) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* カテゴリ別にセクションを出力 */}}
{{ $sortedCategories := slice "要件定義・開発" "メディアエディタ" "3Dエディタ" "ビジネスツール" "事業構築" "従業員" "SNS・マーケティング" "プライベート" }}

{{ range $categoryName := $sortedCategories }}
  {{ $items := index $categories $categoryName }}
  {{ if $items }}
    <div class="dashboard-sections">
      <h2 class="dashboard-section-title">{{ $categoryName }}</h2>
      <div class="dashboard-links">
        {{ range $item := $items }}
          {{/* プライベートファイルの判定 */}}
          {{ $isPrivate := false }}
          {{ $filename := "" }}
          {{ range $fname, $fcontent := $.Site.Data.saas }}
            {{ range $fitem := $fcontent }}
              {{ if eq $fitem.id $item.id }}
                {{ $filename = $fname }}
                {{ $isPrivate = or $item.private (hasPrefix $fname "private_") }}
              {{ end }}
            {{ end }}
          {{ end }}
          
          {{/* カードの生成 */}}
          {{ $onClick := "" }}
          {{ if hasPrefix $item.id "requirements-" }}
            {{ $docId := strings.TrimPrefix $item.id "requirements-" }}
            {{ $onClick = printf "showRequirements('%s'); return false;" $docId }}
          {{ else if eq $item.id "slide-generator" }}
            {{ $onClick = "showBusinessTool('slide-generator'); return false;" }}
          {{ else if or (eq $item.category_name "事業構築") (eq $item.category_name "従業員") (eq $item.category_name "SNS・マーケティング") }}
            {{ $onClick = printf "showSectionById('%s'); return false;" $item.id }}
          {{ else }}
            {{ $appId := strings.TrimPrefix $item.id "saas-" }}
            {{ $onClick = printf "showSaasApp('%s'); return false;" $appId }}
          {{ end }}
          
          {{/* ビデオまたは画像の決定 */}}
          {{ $media := "" }}
          {{ $mediaAlt := $item.title }}
          {{ if $item.video }}
            {{ $media = printf "<video src=\"%s\" alt=\"%s\" style=\"width: 100%%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;\" autoplay loop muted playsinline></video>" $item.video $mediaAlt }}
          {{ else if $item.image }}
            {{ $media = printf "<img src=\"%s\" alt=\"%s\" style=\"width: 100%%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;\">" $item.image $mediaAlt }}
          {{ else }}
            {{/* デフォルトの動画を設定 */}}
            {{ $defaultVideo := "/videos/default_card.mp4" }}
            {{ $media = printf "<video src=\"%s\" alt=\"%s\" style=\"width: 100%%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;\" autoplay loop muted playsinline></video>" $defaultVideo $mediaAlt }}
          {{ end }}
          
          <a href="#{{ $item.id }}" class="saas-app-card" onclick="{{ $onClick | safeJS }}">
            {{ $media | safeHTML }}
            <div class="saas-app-title">
              {{ $item.title }}
              {{ if $isPrivate }}
                <span class="private-badge">🔒</span>
              {{ end }}
              <span class="saas-app-arrow">→</span>
            </div>
            {{ if $item.content }}
              <div class="saas-app-description">{{ $item.content | markdownify }}</div>
            {{ end }}
            {{ if $item.features }}
              <div class="saas-app-features">
                {{ range $item.features }}
                  • {{ . }}<br>
                {{ end }}
              </div>
            {{ end }}
          </a>
        {{ end }}
      </div>
    </div>
  {{ end }}
{{ end }}

{{/* 残りのカテゴリを処理（上記の定義済みカテゴリに含まれないもの） */}}
{{ range $categoryName, $items := $categories }}
  {{ if not (in $sortedCategories $categoryName) }}
    <div class="dashboard-sections">
      <h2 class="dashboard-section-title">{{ $categoryName }}</h2>
      <div class="dashboard-links">
        {{ range $item := $items }}
          {{/* プライベートファイルの判定 */}}
          {{ $isPrivate := false }}
          {{ $filename := "" }}
          {{ range $fname, $fcontent := $.Site.Data.saas }}
            {{ range $fitem := $fcontent }}
              {{ if eq $fitem.id $item.id }}
                {{ $filename = $fname }}
                {{ $isPrivate = or $item.private (hasPrefix $fname "private_") }}
              {{ end }}
            {{ end }}
          {{ end }}
          
          {{/* カードの生成 */}}
          {{ $onClick := printf "showSectionById('%s'); return false;" $item.id }}
          
          {{/* ビデオまたは画像の決定 */}}
          {{ $media := "" }}
          {{ $mediaAlt := $item.title }}
          {{ if $item.video }}
            {{ $media = printf "<video src=\"%s\" alt=\"%s\" style=\"width: 100%%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;\" autoplay loop muted playsinline></video>" $item.video $mediaAlt }}
          {{ else if $item.image }}
            {{ $media = printf "<img src=\"%s\" alt=\"%s\" style=\"width: 100%%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;\">" $item.image $mediaAlt }}
          {{ else }}
            {{/* デフォルトの動画を設定 */}}
            {{ $defaultVideo := "/videos/default_card.mp4" }}
            {{ $media = printf "<video src=\"%s\" alt=\"%s\" style=\"width: 100%%; height: 180px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;\" autoplay loop muted playsinline></video>" $defaultVideo $mediaAlt }}
          {{ end }}
          
          <a href="#{{ $item.id }}" class="saas-app-card" onclick="{{ $onClick | safeJS }}">
            {{ $media | safeHTML }}
            <div class="saas-app-title">
              {{ $item.title }}
              {{ if $isPrivate }}
                <span class="private-badge">🔒</span>
              {{ end }}
              <span class="saas-app-arrow">→</span>
            </div>
            {{ if $item.content }}
              <div class="saas-app-description">{{ $item.content | markdownify }}</div>
            {{ end }}
            {{ if $item.features }}
              <div class="saas-app-features">
                {{ range $item.features }}
                  • {{ . }}<br>
                {{ end }}
              </div>
            {{ end }}
          </a>
        {{ end }}
      </div>
    </div>
  {{ end }}
{{ end }}

{{/* 必要なJavaScript関数 */}}
<script>
  // 汎用: 任意のセクションを表示
  window.showSectionById = function(id) {
    document.querySelectorAll('.doc-section').forEach(section => {
      section.style.display = 'none';
    });
    const target = document.getElementById(id);
    if (target) {
      target.style.display = 'block';
      window.history.pushState({ direct: id }, '', '#' + id);
      window.scrollTo(0, 0);
    }
  }
  
  // ビジネスツール表示用の関数
  window.showBusinessTool = function(toolId) {
    document.querySelectorAll('.doc-section').forEach(section => {
      section.style.display = 'none';
    });
    
    const targetSection = document.getElementById(toolId);
    if (targetSection) {
      targetSection.style.display = 'block';
      window.history.pushState({ direct: toolId }, '', '#' + toolId);
      window.scrollTo(0, 0);
    }
  }

  // SaaSアプリ表示用の関数
  window.showSaasApp = function(appId) {
    document.querySelectorAll('.doc-section').forEach(section => {
      section.style.display = 'none';
    });
    
    const targetId = 'saas-' + appId;
    const targetSection = document.getElementById(targetId);
    if (targetSection) {
      targetSection.style.display = 'block';
      window.history.pushState({ direct: targetId }, '', '#' + targetId);
      window.scrollTo(0, 0);
    }
  }

  // 要件定義書表示用の関数
  window.showRequirements = function(docId) {
    document.querySelectorAll('.doc-section').forEach(section => {
      section.style.display = 'none';
    });
    
    let targetId;
    if (docId === 'views') {
      targetId = 'ui-views';
    } else {
      targetId = 'requirements-' + docId;
    }
    
    const targetSection = document.getElementById(targetId);
    if (targetSection) {
      targetSection.style.display = 'block';
      window.history.pushState({ direct: targetId }, '', '#' + targetId);
      window.scrollTo(0, 0);
    }
  }

  // ブラウザの戻る/進むボタンへの対応
  window.addEventListener('popstate', function(event) {
    if (event.state && event.state.direct) {
      showSectionById(event.state.direct);
    } else {
      // ダッシュボードに戻す
      document.querySelectorAll('.doc-section').forEach(section => {
        if (section.id === 'saas-applications-overview') {
          section.style.display = 'block';
        } else {
          section.style.display = 'none';
        }
      });
    }
  });
  
  // ページ読み込み時にURLをチェック
  document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash && hash.startsWith('#saas-')) {
      const appId = hash.replace('#saas-', '');
      setTimeout(() => showSaasApp(appId), 100);
    } else if (hash && hash.startsWith('#requirements-')) {
      const docId = hash.replace('#requirements-', '');
      setTimeout(() => showRequirements(docId), 100);
    } else if (hash === '#ui-views') {
      setTimeout(() => showRequirements('views'), 100);
    } else if (hash === '#slide-generator') {
      setTimeout(() => showBusinessTool('slide-generator'), 100);
    } else if (hash === '#biz-strategy' || hash === '#biz-finance' || hash === '#prompts-repo') {
      setTimeout(() => showSectionById(hash.replace('#','')), 100);
    } else {
      // デフォルトはダッシュボードのみ表示
      document.querySelectorAll('.doc-section').forEach(section => {
        if (section.id === 'saas-applications-overview') {
          section.style.display = 'block';
        } else {
          section.style.display = 'none';
        }
      });
    }
  });
</script>